{% extends "layout.html" %}
{% block title %}Search Results{% endblock %}

{% block content %}
<div class="container">
    <h2 class="text-white mb-4">Search Results for "{{ query }}"</h2>

    <!-- âœ… Subject-Specific Cards -->
    {% if subjects %}
    <h3 class="text-warning">Subjects</h3>
    <div class="row g-4" id="subjectCards">
        {% for subject in subjects %}
        <div class="col-md-6 col-lg-6 subject-card">
            <div class="card shadow border border-primary">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-1">{{ subject.name }} 
                        <span class="badge bg-warning text-dark neon-id-badge">ID {{ subject.id }}</span>
                    </h5>
                    <div>
                        <a href="{{ url_for('admin.edit_subject', id=subject.id) }}" class="text-white me-2" title="Edit Subject">
                            <i class="fas fa-edit"></i>
                        </a>
                        <form action="{{ url_for('admin.delete_subject', id=subject.id) }}" method="post" class="d-inline">
                            <button class="btn btn-sm btn-link text-white p-0" title="Delete Subject"
                                    onclick="return confirm('Are you sure you want to delete this subject?')">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </form>
                    </div>
                </div>

                <div class="card-body">
                    <p class="text-muted">{{ subject.description }}</p>

                    <!-- âœ… Chapters Table -->
                    <div class="table-responsive">
                        <table class="table table-bordered mt-3">
                            <thead class="table-light text-center">
                                <tr>
                                    <th>Chapter Name</th>
                                    <th>Questions</th>
                                    <th style="width: 120px;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if subject.chapters %}
                                    {% for chapter in subject.chapters %}
                                    <tr>
                                        <td>{{ chapter.name }}</td>
                                        <td class="text-center">
                                            {{ chapter.quizzes | map(attribute='questions') | map('length') | sum }}
                                        </td>
                                        <td class="text-center">
                                            <a href="{{ url_for('admin.edit_chapter', id=chapter.id) }}" class="btn btn-warning btn-sm">Edit</a>
                                            <form action="{{ url_for('admin.delete_chapter', id=chapter.id) }}" method="post" class="d-inline">
                                                <button class="btn btn-danger btn-sm" onclick="return confirm('Delete this chapter?')">
                                                    <i class="fas fa-trash-alt"></i> DLT
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="3" class="text-center text-muted">No chapters available.</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>

                    <!-- âœ… Add Chapter Button -->
                    <a href="{{ url_for('admin.add_chapter', subject_id=subject.id) }}" class="btn btn-success btn-sm w-100 mt-2">
                        <i class="fas fa-plus-circle"></i> Add Chapter
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    <!-- âœ… Chapters Section -->
    {% if chapters %}
    <h3 class="text-warning mt-4">Chapters</h3>
    <div class="row g-4" id="chapterCards">
        {% for chapter in chapters %}
        <div class="col-md-6 col-lg-6 chapter-card">
            <div class="card shadow border border-primary">
    
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1">{{ chapter.name }} 
                            <span class="badge bg-warning text-dark neon-id-badge">ID {{ chapter.id }}</span>
                        </h5>
                    </div>
                </div>
    
                <div class="card-body">
                    <!-- âœ… Quizzes Table -->
                    <div class="table-responsive">
                        <table class="table table-bordered mt-3">
                            <thead class="table-light text-center">
                                <tr>
                                    <th style="width: 50px;">ID</th>
                                    <th>Quiz Title</th>
                                    <th>Quiz Date</th>
                                    <th style="width: 140px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if chapter.quizzes %}
                                    {% for quiz in chapter.quizzes %}
                                    <tr class="quiz-row">
                                        <td class="quiz-id">{{ quiz.id }}</td>
                                        <td class="quiz-name">
                                            <a href="{{ url_for('admin.view_quiz', quiz_id=quiz.id) }}" 
                                               class="text-decoration-none text-primary fw-bold">
                                                {{ quiz.name }}
                                            </a>
                                        </td>  
                                        <td class="quiz-date">{{ quiz.date_of_quiz.strftime('%Y-%m-%d') if quiz.date_of_quiz else 'N/A' }}</td>                                  
                                        <td class="text-center">
                                            <a href="{{ url_for('admin.edit_quiz', id=quiz.id) }}" class="btn btn-warning btn-sm">Edit</a>
                                            <form action="{{ url_for('admin.delete_quiz', id=quiz.id) }}" method="post" class="d-inline">
                                                <button class="btn btn-danger btn-sm" onclick="return confirm('Delete this quiz?')">
                                                    <i class="fas fa-trash-alt"></i> DLT
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">No quizzes available.</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
    
                    <!-- âœ… Only Show "Add Question" If Quiz Exists -->
                    {% if chapter.quizzes %}
                        <a href="{{ url_for('admin.add_question', quiz_id=chapter.quizzes[0].id) }}" 
                        class="btn btn-success btn-sm w-100 mt-2">
                        <i class="fas fa-plus-circle"></i> Add Question
                        </a>
                    {% else %}
                        <a href="{{ url_for('admin.add_quiz') }}" 
                        class="btn btn-primary btn-sm w-100 mt-2">
                            <i class="fas fa-plus-circle"></i> Add Quiz
                    </a>
                    {% endif %}
                </div>
    
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    <!-- âœ… Quiz Section -->
    {% if quizzes %}
    <h3 class="text-warning mt-4">Quizzes</h3>
    <div class="row g-4">
        {% for quiz in quizzes %}
        <div class="col-md-6 col-lg-6">
            <div class="card shadow border border-primary">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <a href="{{ url_for('admin.view_quiz', quiz_id=quiz.id) }}" class="text-white text-decoration-none">
                        <h5 class="mb-0">ðŸ“– {{ quiz.name }}</h5>
                    </a>
                </div>

                <div class="card-body">
                    <p><strong>Subject:</strong> {{ quiz.chapter.subject.name }}</p>
                    <p><strong>Chapter:</strong> {{ quiz.chapter.name }}</p>

                    <!-- âœ… Questions Table -->
                    <div class="table-responsive">
                        <table class="table table-bordered mt-3">
                            <thead class="table-light text-center">
                                <tr>
                                    <th>ID</th>
                                    <th>Question Statement</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if quiz.questions %}
                                    {% for question in quiz.questions %}
                                    <tr>
                                        <td>{{ question.id }}</td>
                                        <td>{{ question.question_statement }}</td>
                                        <td class="text-center">
                                            <a href="{{ url_for('admin.edit_question', question_id=question.id) }}" class="btn btn-warning btn-sm">Edit</a>
                                            <form action="{{ url_for('admin.delete_question', question_id=question.id) }}" method="post" class="d-inline">
                                                <button class="btn btn-danger btn-sm" onclick="return confirm('Delete this question?')">Delete</button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="3" class="text-center text-muted">No questions added yet.</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>

                    <!-- âœ… Add Question Button -->
                    <a href="{{ url_for('admin.add_question', quiz_id=quiz.id) }}" class="btn btn-success btn-sm w-100 mt-2">
                        <i class="fas fa-plus-circle"></i> Add Question
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
<!-- filepath: c:\Users\shaad\Documents\quiz_master-main\app\templates\admin\search_results.html -->
<!-- âœ… Recent Users Section -->
{% if users %}
<h3 class="text-warning mt-4">Your Searched User Data</h3>
<div class="table-responsive">
    <table class="table table-bordered">
        <thead class="table-light">
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Qualification</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>{{ user.fullname }}</td>
                <td>{{ user.email }}</td>
                <td>{{ user.qualification }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}
<!-- âœ… Recent Quiz Attempts Section -->
{% if recent_attempts %}
<h3 class="text-warning mt-4">Recent Quiz Attempts by User</h3>
<div class="table-responsive">
    <table class="table table-bordered">
        <thead class="table-light">
            <tr>
                <th>User</th>
                <th>Quiz</th>
                <th>Score</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody>
            {% for attempt in recent_attempts %}
            <tr>
                <td>{{ attempt.user.fullname if attempt.user else "Unknown" }}</td>
                <td>{{ attempt.quiz.name if attempt.quiz else "Unknown" }}</td>
                <td>{{ attempt.total_scored }}</td>
                <td>{{ attempt.timestamp.strftime('%Y-%m-%d') if attempt.timestamp else "N/A" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}


<!-- âœ… Styling -->
<style>
    .page-title {
        font-size: 2.5rem;
        font-weight: bold;
        color: #00f2fe;
        text-shadow: 0 0 15px #00f2fe;
        margin-bottom: 2rem;
        text-align: center;
    }
    .sub-title {
        font-size: 1.8rem;
        font-weight: bold;
        color: #fff;
        text-shadow: 0 0 10px #4facfe;
        margin-bottom: 1.5rem;
        text-align: center;
    }
    .card {
        transition: transform 0.3s, box-shadow 0.3s;
        min-height: 100%;
    }
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0 20px rgba(0, 123, 255, 0.4);
    }
    .table {
        width: 100%;
    }
    .quiz-name a:hover {
        text-shadow: 0 0 10px #00f2fe;
    }
</style>

{% endblock %}
